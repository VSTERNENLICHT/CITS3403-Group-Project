<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculate Scores | CalcMyWAM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='final-style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .sidebar {
      width: 200px;
      background-color: #f4f4f4;
      border-right: 1px solid #ccc;
      padding: 10px 15px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }

    .sidebar h3 {
      margin-top: 0;
    }

    .tab-button {
      display: block;
      width: 100%;
      padding: 8px;
      margin-bottom: 5px;
      text-align: left;
      cursor: pointer;
      background-color: #e0e0e0;
      border: none;
      border-radius: 4px;
    }

    .tab-button.active {
      background-color: #d0d0ff;
      font-weight: bold;
    }

    .main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-top: 0;
    }

    .tab-name-editor input {
      width: 100%;
      padding: 6px;
      font-size: 1rem;
    }

    .form-container {
    width: 100%;
    display: none;
    flex-direction: column;
    align-items: center;
    }

    .form-container.active {
    display: flex;
    }

    .tab-name-editor {
    margin-bottom: 15px;
    width: 30%; 
    }

    .form-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    flex-wrap: nowrap; /* force items to stay on one line */
    width: 100%;
    overflow-x: auto;
    position: relative;
    }

    .form-section label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      align-items: center;
      text-align: center;
    }

    select, input[type="number"], input[type="checkbox"] {
      padding: 4px;
      width: 120px;
    }

    .remove-section {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: red;
    }

    .button-row {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
    }
    .tabs-list {
      max-height: calc(100vh - 220px); /* leaves space for header + buttons */
      overflow-y: auto;
      padding-right: 5px;
    }

    .add-tab-container {
      margin-top: 10px;
    }

    .calculate-btn-container {
      position: sticky;
      bottom: 0;
      background-color: #f4f4f4;
      padding-top: 10px;
      padding-bottom: 10px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-white text-dark">
  <!-- ✅ Header stays at top, outside the flex container -->
  <header class="border-top pt-2 pb-2 px-5">
    <div class="d-flex justify-content-between align-items-center mb-1 pt-0">
      <a href="#" class="d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="CalcMyWAM Logo" height="60">
      </a>
      <button class="btn btn-outline-primary d-flex align-items-center justify-content-center" title="Log out" style="width: 44px; height: 44px;">
        <i class="bi bi-box-arrow-right fs-5 logout-icon"></i>
      </button>
    </div>
  </header>

  <!-- ✅ Now wrap sidebar + main in a flex container -->
  <div class="container-fluid d-flex p-0" style="height: calc(100vh - 100px);">
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column justify-content-between">
      <div>
        <div id="tabs" class="tabs-list mb-3"></div>
    
        <div class="add-tab-container text-center">
          <button class="btn btn-primary w-100" onclick="addTab()">+ Add Tab</button>
        </div>
      </div>
    
      <div class="calculate-btn-container text-center p-3">
        <button class="btn btn-primary w-100">Calculate</button>
      </div>
    </div>

    <!-- Main content area -->
    <div class="main">
      <div class="top-bar">
        <h2>CalcMyWAM</h2>
      </div>
      <div class="tab-name-editor">
        <input type="text" id="tabNameInput" placeholder="Tab Name" oninput="renameTab(this.value)">
      </div>
      <div id="contentArea"></div>
      <div class="button-row">
        <button class="btn-primary" onclick="addFormSection()">Add New Section</button>
        <button class="btn-primary" onclick="submitData()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    let tabCount = 0;
    let activeTabId = null;
    const tabs = {};

    function addTab() {
      const tabId = `tab${tabCount++}`;
      tabs[tabId] = [];

      const tabButton = document.createElement('div');
      tabButton.className = 'tab-button d-flex justify-content-between align-items-center';
      tabButton.dataset.tabId = tabId;

      const label = document.createElement('span');
      label.className = 'tab-label flex-grow-1';
      label.textContent = `Tab ${tabCount}`;
      label.onclick = () => switchTab(tabId);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn-close btn-sm ms-2';
      closeBtn.setAttribute('aria-label', 'Close');
      closeBtn.onclick = (event) => deleteTab(tabId, event);

      tabButton.appendChild(label);
      tabButton.appendChild(closeBtn);
      document.getElementById('tabs').appendChild(tabButton);

      const tabContent = document.createElement('div');
      tabContent.className = 'form-container';
      tabContent.id = tabId;

      document.getElementById('contentArea').appendChild(tabContent);

      switchTab(tabId); // Switch to the new tab immediately
    }

    function deleteTab(tabId, event) {
      event.stopPropagation(); // Prevents triggering the switchTab when clicking the X

      // Remove tab button and content
      const tabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
      const tabContent = document.getElementById(tabId);
      tabButton?.remove();
      tabContent?.remove();

      // Clean up state
      delete tabs[tabId];

      // Switch to another tab if the active one was deleted
      if (activeTabId === tabId) {
        const remainingTabs = document.querySelectorAll('.tab-button');
        if (remainingTabs.length > 0) {
          switchTab(remainingTabs[0].dataset.tabId);
        } else {
          activeTabId = null;
          document.getElementById('tabNameInput').value = '';
        }
      }
    }

    function switchTab(tabId) {
      activeTabId = tabId;

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tabId === tabId);
      });

      document.querySelectorAll('.form-container').forEach(container => {
        container.classList.toggle('active', container.id === tabId);
      });

      const currentTabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
      document.getElementById('tabNameInput').value = currentTabButton.textContent;
    }

    function renameTab(newName) {
      const currentTabButton = document.querySelector(`.tab-button[data-tab-id="${activeTabId}"] .tab-label`);
      if (currentTabButton) currentTabButton.textContent = newName || 'Unnamed Tab';
    }

    function addFormSection() {
      if (!activeTabId) return;

      const container = document.getElementById(activeTabId);

      const section = document.createElement('div');
      section.className = 'form-section';

      section.innerHTML = `
        <button class="remove-section" onclick="this.parentElement.remove()">×</button>

        <label>
          Completed?<br>
          <input type="checkbox" name="completed[]">
        </label>        

        <label>
          Weighting (%):
          <input type="number" min="0" max="100" step="1" name="weighting[]">
        </label>

        <label>
          Marks Available:
          <input type="number" min="0" step="any" name="marksAvailable[]">
        </label>

        <label>
          Your Marks:
          <input type="number" min="0" step="any" name="yourMarks[]">
        </label>
      `;

      /*<label>
          Assessment Type:
          <select name="assessmentType[]">
            <option value="Test">Test</option>
            <option value="Project">Project</option>
            <option value="Research Paper">Research Paper</option>
            <option value="Presentation">Presentation</option>
            <option value="Lab">Lab</option>
            <option value="Exam">Exam</option>
          </select>
        </label>*/

      container.appendChild(section);
    }

    function submitData() {
      const allTabs = document.querySelectorAll('.form-container');
      const result = {};

      allTabs.forEach(tab => {
        const tabId = tab.id;
        const sections = tab.querySelectorAll('.form-section');
        const assessments = [];

        sections.forEach(section => {
          const completed = section.querySelector('input[type="checkbox"]').checked;
          const type = section.querySelector('select').value;
          const weighting = parseFloat(section.querySelector('input[name="weighting[]"]').value) || 0;
          const available = parseFloat(section.querySelector('input[name="marksAvailable[]"]').value) || 0;
          const yourMarks = parseFloat(section.querySelector('input[name="yourMarks[]"]').value) || 0;

          assessments.push([completed, type, weighting, available, yourMarks]);
        });

        const tabName = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`)?.textContent || tabId;
        result[tabName] = assessments;
      });

      fetch('https://server.com/WIP', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ assessments: result })
      })
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then(result => {
        console.log("Success:", result);
        alert("Data submitted successfully!");
      })
      .catch(error => {
        console.error("Error submitting data:", error);
        alert("There was an error submitting the data.");
      });
    }

    // Initialize with one tab to start
    addTab();
  </script>
</body>
</html>
