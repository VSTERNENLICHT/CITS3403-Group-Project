<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Results Summary | CalcMyWAM</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='final-style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
  </head>

  <body class="bg-white text-dark">
    <!-- Header -->
    <header class="border-top pt-2 pb-2 px-5">
      <div class="d-flex justify-content-between align-items-center mb-1 pt-0">
        <a href="#" class="d-flex align-items-center gap-2">
          <img src="{{ url_for('static', filename='img/logo.png') }}" alt="CalcMyWAM Logo" height="60">
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-primary d-flex align-items-center justify-content-center" style="width: 44px; height: 44px;">
          <i class="bi bi-box-arrow-right fs-5 logout-icon"></i>
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container section-spaced">
      <h2 class="text-center display-6 text-primary mb-5">Summary</h2>

      <!-- Predicted and Desired GPA/WAM Cards -->
      <div class="d-flex flex-column flex-md-row justify-content-around text-center mb-5">
        <div class="mb-4 mb-md-0">
          <div class="fw-bold fs-4">Predicted GPA/WAM</div>
          <div class="result-card d-flex align-items-center justify-content-center">
            <div id="predicted-wam"></div>
          </div>
        </div>
        <div>
          <div class="fw-bold fs-4">Desired GPA/WAM</div>
          <div class="result-card d-flex align-items-center justify-content-center">
            <div id="desired-wam"></div>
          </div>
          <div class="d-flex flex-column align-items-center mt-3">
            <a href="/reset" class="btn btn-outline-primary d-flex align-items-center gap-2">
              <i class="bi bi-arrow-clockwise"></i> Reset Goals
            </a>
          </div>
        </div>
      </div>

      <!-- GPA and WAM Rectangle Section -->
      <section class="section-results text-center">
        <!-- GPA and WAM Line Charts -->
        <div class="mt-5">
          <canvas id="gpaChart" class="mb-5"></canvas>
          <canvas id="wamChart"></canvas>
        </div>

        <div class="row h-100">
          <div class="col-md-6 d-flex flex-column justify-content-center">
            <h5 class="fw-bold fs-1 mb-4">GPA</h5>
            <div id="gpa-value"></div>
          </div>

          <div class="col-md-6 d-flex flex-column justify-content-center">
            <h5 class="fw-bold fs-1 mb-4">WAM</h5>
            <div id="wam-value"></div>
          </div>
        </div>

        <!-- Share Icons -->
        <div class="upload-icons">
          <a href="/share" class="text-decoration-none text-primary fs-2">
            <i class="bi bi-share"></i>
          </a>
          <a href="/share" class="text-decoration-none text-primary fs-2">
            <i class="bi bi-share"></i>
          </a>
        </div>
      </section>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- GPA/WAM Result + Graph Renderer -->
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const response = await fetch('/api/results');
        const data = await response.json();

        if (data.error) {
          console.error(data.error);
          return;
        }

        // Step 1: Insert GPA/WAM values into the boxes
        document.getElementById('gpa-value').innerText = data.gpa.toFixed(2);
        document.getElementById('wam-value').innerText = data.wam.toFixed(2);
        document.getElementById('predicted-wam').innerText = `GPA: ${data.gpa} | WAM: ${data.wam}`;
        document.getElementById('desired-wam').innerText = `GPA: ${data.desired_gpa} | WAM: ${data.desired_wam}`;

        // Step 2: Prepare data for graphs
        const labels = ['Sem 1 Year 1', 'Sem 2 Year 1', 'Sem 1 Year 2', 'Sem 2 Year 2'];
        const gpaData = Object.values(data.gpa_semesters).map(val => val === -1 ? null : val);
        const wamData = Object.values(data.wam_semesters).map(val => val === -1 ? null : val);

        // Step 3: Inject canvases for graphs
        const chartContainer = document.createElement('div');
        chartContainer.className = 'mt-5';
        chartContainer.innerHTML = `
          <canvas id="gpaChart" class="mb-5"></canvas>
          <canvas id="wamChart"></canvas>
        `;
        document.querySelector('main').appendChild(chartContainer);

        // Step 4: Render GPA Chart
        new Chart(document.getElementById('gpaChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'GPA per Semester',
              data: gpaData,
              fill: false,
              borderColor: '#133e87',
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { min: 0, max: 7 }
            }
          }
        });

        // Step 5: Render WAM Chart
        new Chart(document.getElementById('wamChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'WAM per Semester',
              data: wamData,
              fill: false,
              borderColor: '#ff9f45',
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { min: 0, max: 100 }
            }
          }
        });
      });
    </script>
  </body>
</html>
