<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculate Scores | CalcMyWAM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='final-style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='calc-style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
</head>
<body class="bg-white text-dark">
  <!-- ✅ Header stays at top, outside the flex container -->
  <header class="border-top pt-2 pb-2 px-5">
    <div class="d-flex justify-content-between align-items-center mb-1 pt-0">
      <a href="#" class="d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="CalcMyWAM Logo" height="60">
      </a>
      <button class="btn btn-outline-primary d-flex align-items-center justify-content-center" title="Log out" style="width: 44px; height: 44px;">
        <i class="bi bi-box-arrow-right fs-5 logout-icon"></i>
      </button>
    </div>
  </header>

  <!-- ✅ Now wrap sidebar + main in a flex container -->
  <div class="container-fluid d-flex p-0" style="height: calc(100vh - 100px);">
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column justify-content-between">
      <div>
        <div id="tabs" class="tabs-list mb-3">
          <div class="tab-button active d-flex justify-content-between align-items-center" data-tab-id="previousUnits" onclick="switchTab('previousUnits')">
            <span class="tab-label flex-grow-1">Previous Units</span>
          </div>
          <hr class="tab-divider">
        </div>    
        <div class="add-tab-container text-center">
          <button class="btn btn-primary w-100" onclick="addTab()">+ Add Tab</button>
          <hr class="tab-divider-small">
          <button class="btn btn-primary w-100" onclick="submitData()">Calculate</button>
        </div>
        <div class="calculate-btn-container text-center p-3">
          
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="main" id="content">
      <div id="tabSettings" class="mb-3">
        <input id="tabNameInput" type="text" class="form-control mb-2" placeholder="Enter tab name" oninput="renameTab()" />
        
        <select id="semesterSelect" class="form-select" onchange="updateSemester()">
          <option value="">Select Semester</option>
          <option value="Semester 1">Semester 1</option>
          <option value="Semester 2">Semester 2</option>
        </select>
        <hr class="tab-divider-small">
        <button id="addButton" class="btn-primary" onclick="handleAddButton()">Add New Section</button>
        <button class="btn-primary">Submit/Save</button> <!--Need on-click functionality? Or just remove-->
      </div>
      <div id="contentArea">
        <div class="form-container active" id="previousUnits">
        </div>
      </div>
      <div class="button-row">
        
      </div>
    </div>
  </div>

  <form id="calcForm" method="POST" action="{{ url_for('calculate') }}">
    <input type="hidden" name="data" id="formData">
  </form>

  <script>
    let tabCount = 0;
    let activeTabId = null;
    //const submitUrl = "{{ url_for('calculate') }}"; // URL for form submission
    const tabs = {};

    function addTab() {
      const tabId = `tab${tabCount++}`;
      tabs[tabId] = {};

      const tabButton = document.createElement('div');
      tabButton.className = 'tab-button d-flex justify-content-between align-items-center';
      tabButton.dataset.tabId = tabId;

      const label = document.createElement('span');
      label.className = 'tab-label flex-grow-1';
      label.textContent = `Tab ${tabCount}`;
      label.onclick = () => switchTab(tabId);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn-close btn-sm ms-2';
      closeBtn.setAttribute('aria-label', 'Close');
      closeBtn.onclick = (event) => deleteTab(tabId, event);

      tabButton.appendChild(label);
      tabButton.appendChild(closeBtn);
      document.getElementById('tabs').appendChild(tabButton);

      const tabContent = document.createElement('div');
      tabContent.className = 'form-container';
      tabContent.id = tabId;

      document.getElementById('contentArea').appendChild(tabContent);

      switchTab(tabId); // Switch to the new tab immediately
    }

    function deleteTab(tabId, event) {
      event.stopPropagation(); // Prevents triggering the switchTab when clicking the X

      // Remove tab button and content
      const tabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
      const tabContent = document.getElementById(tabId);
      tabButton?.remove();
      tabContent?.remove();

      // Clean up state
      delete tabs[tabId];

      // Switch to another tab if the active one was deleted
      if (activeTabId === tabId) {
        const remainingTabs = document.querySelectorAll('.tab-button');
        if (remainingTabs.length > 0) {
          switchTab(remainingTabs[0].dataset.tabId);
        } else {
          activeTabId = null;
          document.getElementById('tabNameInput').value = '';
        }
      }
    }

    function handleAddButton() {
      if (activeTabId === 'previousUnits') {
        addPreviousUnit();
      } else {
        addFormSection();
      }
    }

    function switchTab(tabId) {
      activeTabId = tabId;

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tabId === tabId);
      });

      document.querySelectorAll('.form-container').forEach(container => {
        container.classList.toggle('active', container.id === tabId);
      });

      const addButton = document.getElementById('addButton');
      const tabSettings = document.getElementById('tabSettings');
      const tabNameInputGroup = document.getElementById('tabNameInput');
      const semesterDropdownGroup = document.getElementById('semesterSelect');

      if (tabId === 'previousUnits') {
        tabSettings.style.display = 'block';
        addButton.textContent = 'Add Previous Unit';
        if (tabNameInput) tabNameInputGroup.style.display = 'none';
        if (semesterSelect) semesterDropdownGroup.style.display = 'none';
      } else {
        tabSettings.style.display = 'block';
        addButton.textContent = 'Add New Section';
        if (tabNameInput) tabNameInputGroup.style.display = 'block';
        if (semesterSelect) semesterDropdownGroup.style.display = 'block';

        const currentTabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
        document.getElementById('tabNameInput').value = currentTabButton?.textContent || '';
        document.getElementById('semesterSelect').value = tabs[tabId].semester || "";
      }
    }

    function renameTab() {
      if (activeTabId === 'previousUnits') return; // Prevent renaming Previous Units
      const newName = document.getElementById('tabNameInput').value;
      const currentTabButton = document.querySelector(`.tab-button[data-tab-id="${activeTabId}"]`);
      if (currentTabButton) {
        const label = currentTabButton.querySelector('.tab-label');
        if (label) {
          label.textContent = newName;
        }
        tabs[activeTabId].name = newName;
      }
    }

    function updateSemester() {
      const selectedSemester = document.getElementById('semesterSelect').value;
      if (tabs[activeTabId]) {
        tabs[activeTabId].semester = selectedSemester;
      }
    }

    function addPreviousUnit() {
      const container = document.getElementById('previousUnits');

      const section = document.createElement('div');
      section.className = 'form-section';

      section.innerHTML = `
        <button class="remove-section" onclick="this.parentElement.remove()">×</button>

        <label>
          Unit Code:
          <input type="text" name="unitCode[]">
        </label>

        <label>
          Semester:
          <select name="semester[]" class="previous-unit-semester">
            ${generateSemesterOptions()}
          </select>
        </label>

        <label>
          Final Mark:
          <input type="number" min="0" max="100" step="1" name="finalMark[]">
        </label>
      `;

      container.appendChild(section);
    }

    function generateSemesterOptions() {
      let options = '';
      for (let year = 2011; year <= 2025; year++) {
        options += `<option value="Semester 1, ${year}">Semester 1, ${year}</option>`;
        options += `<option value="Semester 2, ${year}">Semester 2, ${year}</option>`;
      }
      return options;
    }

    function addFormSection() {
      if (!activeTabId) return;

      const container = document.getElementById(activeTabId);

      const section = document.createElement('div');
      section.className = 'form-section';

      section.innerHTML = `
        <button class="remove-section" onclick="this.parentElement.remove()">×</button>

        <label>
          Completed?<br>
          <input type="checkbox" name="completed[]">
        </label>        

        <label>
          Weighting (%):
          <input type="number" min="0" max="100" step="1" name="weighting[]">
        </label>

        <label>
          Marks Available:
          <input type="number" min="0" step="any" name="marksAvailable[]">
        </label>

        <label>
          Your Marks:
          <input type="number" min="0" step="any" name="yourMarks[]">
        </label>
      `;

      /*<label>
          Assessment Type:
          <select name="assessmentType[]">
            <option value="Test">Test</option>
            <option value="Project">Project</option>
            <option value="Research Paper">Research Paper</option>
            <option value="Presentation">Presentation</option>
            <option value="Lab">Lab</option>
            <option value="Exam">Exam</option>
          </select>
        </label>*/

      container.appendChild(section);
    }

    /*function submitData() {
      const allTabs = document.querySelectorAll('.form-container');
      const result = {};

      allTabs.forEach(tab => {
        const tabId = tab.id;
        const sections = tab.querySelectorAll('.form-section');
        const assessments = [];

        sections.forEach(section => {
          const completed = section.querySelector('input[type="checkbox"]').checked;
          const weighting = parseFloat(section.querySelector('input[name="weighting[]"]').value) || 0;
          const available = parseFloat(section.querySelector('input[name="marksAvailable[]"]').value) || 0;
          const yourMarks = parseFloat(section.querySelector('input[name="yourMarks[]"]').value) || 0;

          assessments.push([completed, weighting, available, yourMarks]);
        });

        const tabName = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`)?.textContent || tabId;
        result[tabName] = assessments;
      });

      fetch('https://server.com/WIP', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ assessments: result })
      })
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then(result => {
        console.log("Success:", result);
        alert("Data submitted successfully!");
      })
      .catch(error => {
        console.error("Error submitting data:", error);
        alert("There was an error submitting the data.");
      });
    }*/

    function submitData() {
      const result = {};

      // Handle Previous Units
      const previousUnitsContainer = document.getElementById('previousUnits');
      const previousSections = previousUnitsContainer.querySelectorAll('.form-section');
      const previousUnits = [];

      previousSections.forEach(section => {
        const unitCode = section.querySelector('input[name="unitCode[]"]').value.trim();
        const semester = section.querySelector('select[name="semester[]"]').value;
        const finalMark = parseFloat(section.querySelector('input[name="finalMark[]"]').value) || 0;

        if (unitCode && semester) {
          previousUnits.push([unitCode, semester, finalMark]);
        }
      });

      result["Previous Units"] = previousUnits;

      // Handle other tabs (regular units)
      const allTabs = document.querySelectorAll('.form-container');
      allTabs.forEach(tab => {
        const tabId = tab.id;
        if (tabId === "previousUnits") return;

        const sections = tab.querySelectorAll('.form-section');
        const semester = tabs[tabId].semester || "Semester 1"; // Default to Semester 1 if not set
        const assessments = [];

        sections.forEach(section => {
          const completed = section.querySelector('input[type="checkbox"]').checked;
          const weighting = parseInt(section.querySelector('input[name="weighting[]"]').value) || 0;
          const available = parseInt(section.querySelector('input[name="marksAvailable[]"]').value) || 0;
          const yourMarks = parseInt(section.querySelector('input[name="yourMarks[]"]').value) || 0;

          assessments.push([completed, weighting, available, yourMarks]);
        });

        const tabName = document.querySelector(`.tab-button[data-tab-id="${tabId}"] .tab-label`)?.textContent || tabId;
        result[tabName] = {"semester": semester, "assessments": assessments};
      });

      // Send via fetch
      /*
      fetch(submitUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(result)
      })
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then(result => {
        console.log("Success:", result);
        alert("Data submitted successfully!");
      })
      .catch(error => {
        console.error("Error submitting data:", error);
        alert("There was an error submitting the data.");
      });*/

      document.getElementById('formData').value = JSON.stringify(result);
      document.getElementById('calcForm').submit();
    }

    // Initialize with one tab to start
    addTab();
  </script>
</body>
</html>
